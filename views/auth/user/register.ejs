<section id="tid-registration-form">
  <div class="px-4 py-5 px-md-5 text-center text-lg-start" style="background-color: hsl(0, 0%, 96%)">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <h3 class="ltext-103 cl5 text-center mb-5">Register</h3>
        </div>
      </div>
      <div class="row gx-lg-5 justify-content-center">
        <div class="col-lg-6 mb-5 mb-lg-0">
          <div class="card">
            <div class="card-body py-5 px-md-5">
              <form id="register_form" action="/register" method="POST">
                <div class="row">
                  <div class="col-md-6 mb-4">
                    <div class="form-outline">
                      <label for="firstName" class="form-label text-left">First Name</label>
                      <input name="firstName" type="text" class="form-control" id="firstName" placeholder="First Name" />
                      <small class="text-danger"></small>
                    </div>
                  </div>
                  <div class="col-md-6 mb-4">
                    <div class="form-outline">
                      <label for="lastName" class="form-label text-left">Last Name</label>
                      <input name="lastName" type="text" class="form-control" id="lastName" placeholder="Last Name" />
                      <small class="text-danger"></small>
                    </div>
                  </div>
                </div>
                <div class="form-outline mb-4">
                  <label for="email" class="form-label text-left">Email</label>
                  <input name="email" type="email" class="form-control" id="email" placeholder="example@gmail.com" />
                  <small class="text-danger"></small>
                </div>
                <div class="form-outline mb-4">
                  <label for="password" class="form-label text-left">Password</label>
                  <div class="input-group">
                    <input name="password" type="password" class="form-control" id="password" />
                    <div class="input-group-append">
                      <span class="input-group-text" onclick="togglePasswordVisibility('password')"><i class="fa fa-eye"></i></span>
                    </div>
                  </div>
                  <small class="text-danger"></small>
                </div>
                <div class="form-outline mb-4">
                  <label for="confirmPassword" class="form-label text-left">Password confirmation</label>
                  <div class="input-group">
                    <input name="confirmPassword" type="password" class="form-control" id="confirmPassword" />
                    <div class="input-group-append">
                      <span class="input-group-text" onclick="togglePasswordVisibility('confirmPassword')"><i class="fa fa-eye"></i></span>
                    </div>
                  </div>
                  <small class="text-danger"></small>
                </div>
                <div class="flex-c-m">
                  <button type="submit" class="flex-c-m stext-101 cl0 size-101 bg1 bor1 hov-btn1 p-lr-15 trans-04">Register</button>
                </div>
                <div class="mt-4">
                  <p>Already have an account? <a href="/login" style="color: black"><u>Login</u></a></p>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  const firstNameEl = document.querySelector("#firstName");
  const lastNameEl = document.querySelector("#lastName");
  const emailEl = document.querySelector("#email");
  const passwordEl = document.querySelector("#password");
  const confirmPasswordEl = document.querySelector("#confirmPassword");

  const form = document.querySelector("#register_form");

  const checkEmail = () => {
    let valid = false;
    const email = emailEl.value.trim();
    if (!isRequired(email)) {
      showError(emailEl, "Email cannot be blank.");
    } else if (!isEmailValid(email)) {
      showError(emailEl, "Email is not valid.");
    } else {
      showSuccess(emailEl);
      valid = true;
    }
    return valid;
  };

  const checkPassword = () => {
    let valid = false;
    const password = passwordEl.value.trim();
    if (!isRequired(password)) {
      showError(passwordEl, "Password cannot be blank.");
    } else if (!isPasswordSecure(password)) {
      showError(passwordEl, "Password must be at least 8 characters, include 1 lowercase, 1 uppercase, 1 number, and 1 special character.");
    } else {
      showSuccess(passwordEl);
      valid = true;
    }
    return valid;
  };

  const checkConfirmPassword = () => {
    let valid = false;
    const confirmPassword = confirmPasswordEl.value.trim();
    const password = passwordEl.value.trim();
    if (!isRequired(confirmPassword)) {
      showError(confirmPasswordEl, "Please enter the password again.");
    } else if (password !== confirmPassword) {
      showError(confirmPasswordEl, "The password does not match.");
    } else {
      showSuccess(confirmPasswordEl);
      valid = true;
    }
    return valid;
  };

  const checkFirstName = () => {
    let valid = false;
    const firstName = firstNameEl.value.trim();
    if (!isRequired(firstName)) {
      showError(firstNameEl, "First name cannot be blank.");
    } else if (!isAlpha(firstName)) {
      showError(firstNameEl, "First name should only contain letters.");
    } else {
      showSuccess(firstNameEl);
      valid = true;
    }
    return valid;
  };

  const checkLastName = () => {
    let valid = false;
    const lastName = lastNameEl.value.trim();
    if (!isRequired(lastName)) {
      showError(lastNameEl, "Last name cannot be blank.");
    } else if (!isAlpha(lastName)) {
      showError(lastNameEl, "Last name should only contain letters.");
    } else {
      showSuccess(lastNameEl);
      valid = true;
    }
    return valid;
  };

  const isAlpha = (value) => /^[a-zA-Z]+$/.test(value);
  const isEmailValid = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  const isPasswordSecure = (password) => /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*])[A-Za-z\d!@#$%^&*]{8,}$/.test(password);
  const isRequired = (value) => value !== "";

  const showError = (input, message) => {
    const formField = input.parentElement;
    formField.classList.remove("success");
    formField.classList.add("error");
    const error = formField.querySelector("small");
    error.textContent = message;
  };

  const showSuccess = (input) => {
    const formField = input.parentElement;
    formField.classList.remove("error");
    formField.classList.add("success");
    const error = formField.querySelector("small");
    error.textContent = "";
  };

  form.addEventListener("submit", function (e) {
    const isFormValid =
      checkFirstName() &&
      checkLastName() &&
      checkEmail() &&
      checkPassword() &&
      checkConfirmPassword();
    if (!isFormValid) {
      e.preventDefault();
    }
  });

  const debounce = (fn, delay = 500) => {
    let timeoutId;
    return (...args) => {
      if (timeoutId) {
        clearTimeout(timeoutId);
      }
      timeoutId = setTimeout(() => {
        fn.apply(null, args);
      }, delay);
    };
  };

  form.addEventListener(
    "input",
    debounce(function (e) {
      switch (e.target.id) {
        case "firstName":
          checkFirstName();
          break;
        case "lastName":
          checkLastName();
          break;
        case "email":
          checkEmail();
          break;
        case "password":
          checkPassword();
          break;
        case "confirmPassword":
          checkConfirmPassword();
          break;
      }
    })
  );

  function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const icon = field.nextElementSibling.querySelector('i');
        if (field.type === 'password') {
            field.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            field.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
</script>
