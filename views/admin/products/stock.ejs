<section class="content-main">
    <ol class="breadcrumb">
        <% breadcrumbs.forEach(function(crumb, index) { %>
            <% if (index === breadcrumbs.length - 1) { %>
                <li class="breadcrumb-item active"><%= crumb.name %></li>
            <% } else { %>
                <li class="breadcrumb-item"><a href="<%= crumb.url %>"><%= crumb.name %></a></li>
            <% } %>
        <% }); %>
    </ol>
    <div class="content-header">
        <div>
            <h2 class="content-title card-title">
                <%= locals.title ? locals.title : 'Dashboard' %>
            </h2>

        </div>

    </div>
    
    <div class="card mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Product</th>
                            <th>Current Stock</th>
                            <th>Update Stock</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% products.forEach((product,index)=> { %>
                            <tr>
                                <td>
                                    <%= (current - 1) * perPage + index + 1 %>
                                </td>

                                <td>
                                    <%= product.product_name %>
                                </td>

                                <td>
                                    <% if (product.stock === 0 || product.stock < 0) { %>
                                        <span class="text text-danger">Out Of Stock</span>
                                    <% } else { %>
                                        <%= product.stock %>
                                    <% } %>
                                </td>

                                <td>
                                    <input type="number" id="newStock-<%= product._id %>" value="<%= product.stock %>"
                                        min="0" />
                                    <button onclick="updateStock('<%= product._id %>')"
                                        class="btn btn-primary btn-sm">Update</button>
                                </td>

                            </tr>


                            <% }) %>




                    </tbody>


                </table>
            </div>

        </div>



    </div>
    <% if (products.length > 0 && (nextPage || current == pages)) { %>
    <nav aria-label="Dashboard pagination">
        <ul class="pagination justify-content-center mt-5">
            <% if (current == 1) { %>
                <li class="page-item disabled"><a href="#" class="page-link">First</a></li>
            <% } else { %>
                <li class="page-item"><a href="/admin/products/stocks/?page=1" class="page-link">First</a></li>
            <% } %>
            <% var i = (Number(current) > 5 ? Number(current) - 4 : 1) %>
            <% if (i !== 1) { %>
                <li class="page-item disabled"><a href="#" class="page-link">...</a></li>
            <% } %>
            <% for (; i <= (Number(current) + 4) && i <= pages; i++) { %>
                <% if (i == current) { %>
                    <li class="page-item disabled"><a href="#" class="page-link"><%= i %></a></li>
                <% } else { %>
                    <li class="page-item"><a href="/admin/products/stocks?page=<%= i %>" class="page-link"><%= i %></a></li>
                <% } %>
            <% if (i == Number(current) + 4 && i < pages) { %>
                <li class="page-item disabled"><a href="#" class="page-link">...</a></li>
            <% } %>
            <% } %>
            <% if (current == pages) { %>
                <li class="page-item disabled"><a href="#" class="page-link">Last</a></li>
            <% } else { %>
                <li class="page-item"><a href="/admin/products/stocks/?page=<%= pages %>" class="page-link">Last</a></li>
            <% } %>
        </ul>
    </nav>
<% } %>

</section> <!-- content-main end// -->



<script>
    function updateStock(productId) {
        const newStock = document.getElementById(`newStock-${productId}`).value;

        if (newStock < 0) {
            Swal.fire(
                'Invalid Input',
                'Stock value cannot be negative.',
                'error'
            );
            return;
        }

        Swal.fire({
            title: 'Are you sure?',
            text: `You are about to update the stock to ${newStock}.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, update it!',
            cancelButtonText: 'No, cancel!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("/admin/product/updateStock", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ productId, newStock })
                }).then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire(
                                'Updated!',
                                'The stock has been updated.',
                                'success'
                            ).then(() => {
                                window.location.reload(); // Reload the page to reflect changes
                            });
                        } else {
                            Swal.fire(
                                'Error!',
                                'There was an error updating the stock.',
                                'error'
                            );
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                        Swal.fire(
                            'Error!',
                            'There was an error updating the stock.',
                            'error'
                        );
                    });
            }
        });
    }
</script>